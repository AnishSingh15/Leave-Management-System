rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    function isMasterAdmin() {
      return getUserRole() == 'master_admin';
    }
    
    function isHRAdmin() {
      return getUserRole() == 'hr_admin' || isMasterAdmin();
    }
    
    function isManager() {
      return getUserRole() == 'manager' || isHRAdmin();
    }
    
    function isEmployee() {
      return getUserRole() == 'employee' || isManager();
    }

    // Users collection
    match /users/{userId} {
      // Anyone authenticated can read user profiles (needed for manager selection)
      allow read: if isAuthenticated();
      
      // Users can create their own profile on registration
      allow create: if isAuthenticated() && isOwner(userId) && 
        (
          request.resource.data.role in ['employee', 'manager', 'hr_admin'] ||
          (request.resource.data.role == 'master_admin' && request.auth.token.email == 'anish15may@gmail.com')
        ) &&
        request.resource.data.annualLeaveBalance == 20 &&
        request.resource.data.compOffBalance == 0;
      
      // Users can update their own basic info, but not role or balances
      // Managers can update compOffBalance for their employees (extra work approval)
      allow update: if isAuthenticated() && (
        (isOwner(userId) && 
          request.resource.data.role == resource.data.role &&
          request.resource.data.annualLeaveBalance == resource.data.annualLeaveBalance &&
          request.resource.data.compOffBalance == resource.data.compOffBalance) ||
        (isManager() && 
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['compOffBalance', 'updatedAt'])) ||
        isHRAdmin()
      );
      
      // Only HR Admin can delete users
      allow delete: if isHRAdmin();
    }

    // Leaves collection
    match /leaves/{leaveId} {
      // Employees can read their own leaves
      // Managers can read leaves assigned to them
      // HR Admin can read all leaves
      allow read: if isAuthenticated() && (
        resource.data.employeeId == request.auth.uid ||
        resource.data.managerId == request.auth.uid ||
        isManager()
      );
      
      // Anyone authenticated can create a leave request for themselves
      allow create: if isAuthenticated() && 
        request.resource.data.employeeId == request.auth.uid &&
        request.resource.data.status == 'pending_manager';
      
      // Manager can update leaves assigned to them (approve/reject)
      // HR Admin can update any leave
      allow update: if isAuthenticated() && (
        // Manager approval/rejection
        (resource.data.managerId == request.auth.uid &&
          resource.data.status == 'pending_manager' &&
          (
            request.resource.data.status == 'pending_hr' || 
            request.resource.data.status == 'rejected' || 
            (resource.data.leaveType == 'extra_work' && request.resource.data.status == 'approved')
          )
        ) ||
        // HR Admin can do anything
        isHRAdmin()
      );
      
      // Only HR Admin can delete leaves
      allow delete: if isHRAdmin();
    }

    // Audit logs collection
    match /auditLogs/{logId} {
      // Managers and HR can read audit logs
      allow read: if isManager();
      
      // Managers and HR can create audit logs
      allow create: if isManager();
      
      // No one can update or delete audit logs
      allow update, delete: if false;
    }

    // Attendance collection
    match /attendance/{attendanceId} {
      // Any authenticated user can read attendance
      allow read: if isAuthenticated();

      // Users can create their own attendance record; Managers can create when approving missed clock-ins
      allow create: if isAuthenticated() && (
        request.resource.data.employeeId == request.auth.uid ||
        isManager()
      );

      // Managers and HR Admin can update attendance
      allow update, delete: if isManager();
    }

    // Missed Clock-In Requests
    match /missedClockIns/{requestId} {
      // Any authenticated user can read missed clock-in requests
      allow read: if isAuthenticated();

      // Employees can create their own missed clock-in requests
      allow create: if isAuthenticated() &&
        request.resource.data.employeeId == request.auth.uid;

      // Managers/HR can update (approve/reject)
      allow update: if isManager();

      // Only HR Admin can delete
      allow delete: if isHRAdmin();
    }

    // Reimbursement Requests
    match /reimbursements/{requestId} {
      // Any authenticated user can read reimbursement requests
      allow read: if isAuthenticated();

      // Employees can create their own reimbursement requests
      allow create: if isAuthenticated() &&
        request.resource.data.employeeId == request.auth.uid;

      // Managers/HR can update (approve/reject)
      allow update: if isManager();

      // Only HR Admin can delete
      allow delete: if isHRAdmin();
    }
  }
}
